<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω Kh√°ch h√†ng - Flower'Lna</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body { 
        background-color: #faf9f7; 
        font-family: 'Roboto', sans-serif; 
        color: #2f2f2f; 
        min-height: 100vh;
    }
    header { 
        background: #fff; 
        border-bottom: 1px solid #eee; 
        padding: 15px 0; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
    }
    .logo { 
        font-family: 'Playfair Display', serif; 
        font-size: 28px; 
        color: #b08c3a; 
        font-weight: 700; 
        letter-spacing: 2px; 
    }
    .contact-info {
        text-align: right;
        color: #7c7c7c;
        font-size: 14px;
    }
    .navbar { 
        background-color: #fff8f0 !important; 
        border-top: 1px solid #eee; 
        border-bottom: 1px solid #eee; 
    }
    .navbar-nav .nav-link { 
        color: #3b2d1f !important; 
        font-weight: 500; 
        text-transform: uppercase; 
        margin: 0 10px; 
    }
    .navbar-nav .nav-link:hover { 
        color: #b08c3a !important; 
    }
    .sidebar { 
        background: #fff; 
        border-right: 1px solid #eee; 
        min-height: calc(100vh - 140px); 
        box-shadow: 2px 0 8px rgba(0,0,0,0.05); 
    }
    .sidebar-header {
        padding: 30px 20px;
        text-align: center;
        border-bottom: 1px solid #eee;
        background: linear-gradient(135deg, #fff8f0 0%, #fff 100%);
    }
    .sidebar .nav-link { 
        color: #3b2d1f; 
        padding: 15px 20px; 
        margin: 5px 15px; 
        border-radius: 8px; 
        transition: all 0.3s ease; 
        border: none;
    }
    .sidebar .nav-link:hover { 
        background-color: #fff8f0; 
        color: #b08c3a; 
        transform: translateX(5px); 
    }
    .sidebar .nav-link.active { 
        background: linear-gradient(135deg, #b08c3a 0%, #d4af37 100%); 
        color: white; 
        box-shadow: 0 4px 15px rgba(176, 140, 58, 0.3);
    }
    .main-content { 
        background: #faf9f7; 
        padding: 30px; 
        min-height: calc(100vh - 140px);
    }
    .page-header {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #eee;
    }
    .page-title { 
        font-family: 'Playfair Display', serif; 
        font-size: 32px; 
        color: #b08c3a; 
        margin-bottom: 5px;
    }
    .page-subtitle {
        color: #7c7c7c;
        font-size: 16px;
        margin-bottom: 0;
    }
    .btn-primary-custom { 
        background: linear-gradient(135deg, #b08c3a 0%, #d4af37 100%); 
        border: none; 
        border-radius: 25px; 
        color: white; 
        padding: 10px 25px; 
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(176, 140, 58, 0.4);
        color: white;
    }
    .table-modern { 
        background: white; 
        border-radius: 12px; 
        overflow: hidden; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
    }
    .table-modern thead { 
        background: linear-gradient(135deg, #b08c3a 0%, #d4af37 100%); 
        color: white; 
    }
    .table-modern th {
        border: none;
        padding: 15px;
        font-weight: 600;
    }
    .table-modern td {
        padding: 15px;
        vertical-align: middle;
    }
    footer { 
        background: #1e1a16; 
        color: #d4c7a0; 
        text-align: center; 
        padding: 40px 0; 
        margin-top: 50px; 
    }
    footer h5 { 
        font-family: 'Playfair Display', serif; 
        font-size: 20px; 
        margin-bottom: 15px; 
    }
    .user-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .user-welcome {
        color: #6c757d;
        font-size: 14px;
    }
    .user-name {
        font-weight: 600;
        color: #2f2f2f;
    }
  </style>
</head>
<body>

<header class="container-fluid">
  <div class="container d-flex justify-content-between align-items-center">
    <a href="index.html" class="logo text-decoration-none">üå∏ Flower'Lna</a>
    <div class="contact-info">
        Hotline: <strong>1800 88 88 88</strong><br>
        Flower'Lna.vn | contact@FlowerLna.vn
    </div>
  </div>
</header>

<nav class="navbar navbar-expand-lg navbar-light">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Trang ch·ªß</a></li>
        <li class="nav-item"><a class="nav-link" href="#">B·ªô s∆∞u t·∫≠p</a></li>
        <li class="nav-item"><a class="nav-link" href="#">D·ªãch v·ª•</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Khuy·∫øn m√£i</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Li√™n h·ªá</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- SIDEBAR -->
    <div class="col-md-3 col-lg-2 sidebar">
      <div class="sidebar-header">
        <h5 class="mb-0">üå∏ Flower'Lna</h5>
        <small class="text-muted">Admin Panel</small>
      </div>
      <nav class="nav flex-column mt-4">
        <a class="nav-link" href="quanli.html">
          <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </a>
        <a class="nav-link" href="hoa.html">
          <i class="bi bi-flower1 me-2"></i>Qu·∫£n l√Ω Hoa
        </a>
        <a class="nav-link" href="loaihoa.html">
          <i class="bi bi-tags me-2"></i>Lo·∫°i Hoa
        </a>
        <a class="nav-link active" href="khachhang.html">
          <i class="bi bi-people me-2"></i>Kh√°ch h√†ng
        </a>
        <a class="nav-link" href="#">
          <i class="bi bi-box-seam me-2"></i>ƒê∆°n h√†ng
        </a>
        <div class="user-info mt-4">
          <div class="user-welcome">Xin ch√†o</div>
          <div class="user-name fw-bold" id="adminName">Admin</div>
        </div>
        <button class="btn btn-outline-secondary mt-3 w-100" onclick="dangXuat()">
          <i class="bi bi-box-arrow-right me-2"></i>ƒêƒÉng xu·∫•t
        </button>
      </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="col-md-9 col-lg-10 main-content">
      <div class="page-header">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="page-title">Qu·∫£n l√Ω Kh√°ch h√†ng</h1>
            <p class="page-subtitle">Danh s√°ch kh√°ch h√†ng mua hoa t·∫°i c·ª≠a h√†ng</p>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#modalKhachHang">
              <i class="bi bi-plus-circle me-2"></i>Th√™m kh√°ch h√†ng
            </button>
          </div>
        </div>
      </div>

      <!-- T√åM KI·∫æM -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" id="searchKhachHang" class="form-control" placeholder="T√¨m theo t√™n, email ho·∫∑c s·ªë ƒëi·ªán tho·∫°i...">
            <button class="btn btn-outline-secondary" type="button">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- B·∫¢NG KH√ÅCH H√ÄNG -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-modern">
              <thead>
                <tr>
                  <th>T√™n kh√°ch h√†ng</th>
                  <th>Email</th>
                  <th>ƒêi·ªán tho·∫°i</th>
                  <th>ƒê·ªãa ch·ªâ</th>
                  <th width="150">Ng√†y ƒëƒÉng k√Ω</th>
                  <th class="text-center" width="120">Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="tbodyKhachHang">
                <tr>
                  <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <h5>Flower'Lna - Hoa Th∆∞·ª£ng L∆∞u</h5>
    <p>ƒê·ªãa ch·ªâ: 88 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM<br>
    Hotline: 1800 88 88 88 | Email: contact@FlowerLna.vn</p>
    <div>
      <a href="#"><i class="bi bi-facebook"></i></a>
      <a href="#"><i class="bi bi-instagram"></i></a>
      <a href="#"><i class="bi bi-twitter"></i></a>
    </div>
    <p class="mt-3">&copy; 2025 Flower'Lna. All Rights Reserved.</p>
  </div>
</footer>

<!-- MODAL TH√äM/S·ª¨A -->
<div class="modal fade" id="modalKhachHang" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Th√™m Kh√°ch h√†ng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formKhachHang">
          <input type="hidden" id="MaKhachHang">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">T√™n kh√°ch h√†ng <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="TenKhachHang" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="Email">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="SoDienThoai" required>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">ƒê·ªãa ch·ªâ</label>
              <input type="text" class="form-control" id="DiaChi">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary-custom" id="btnSaveKH">L∆∞u</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_KH = '../api/khachhang.php';

// Ki·ªÉm tra ƒëƒÉng nh·∫≠p
function kiemTraDangNhap() {
    const nguoiDung = localStorage.getItem('nguoiDung');
    const daDangNhap = localStorage.getItem('daDangNhap');
    
    console.log('üîç Ki·ªÉm tra ƒëƒÉng nh·∫≠p:', { 
        daDangNhap: daDangNhap,
        nguoiDung: nguoiDung 
    });
    
    if (!daDangNhap || daDangNhap !== 'true' || !nguoiDung) {
        console.log('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng ƒë·∫øn login');
        window.location.href = 'login.html';
        return false;
    }

    try {
        const user = JSON.parse(nguoiDung);
        console.log('üë§ Th√¥ng tin user t·ª´ localStorage:', user);
        
        if (user.VaiTro !== 'quantri') {
            console.log('üö´ User kh√¥ng ph·∫£i admin, chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß');
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!');
            window.location.href = 'index.html';
            return false;
        }
        
        $('#adminName').text(user.HoTen || user.Email || 'Admin');
        console.log('‚úÖ ƒê√£ x√°c th·ª±c th√†nh c√¥ng v·ªõi quy·ªÅn admin');
        return true;
        
    } catch (e) {
        console.error('‚ùå L·ªói parse user data:', e);
        window.location.href = 'login.html';
        return false;
    }
}

function loadKhachHang(search = '') {
    let url = API_KH;
    if (search) {
        url += '?search=' + encodeURIComponent(search);
    }
    
    console.log('üîÑ Loading khachhang from:', url);
    
    $('#tbodyKhachHang').html(`
        <tr>
            <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </td>
        </tr>
    `);
    
    $.ajax({
        url: url,
        type: 'GET',
        success: function(data) {
            console.log('‚úÖ Khachhang data received:', data);
            const list = Array.isArray(data) ? data : [data];
            console.log('üìä S·ªë l∆∞·ª£ng kh√°ch h√†ng:', list.length);
            renderTable(list);
        },
        error: function(xhr, status, error) {
            console.error('‚ùå L·ªói t·∫£i kh√°ch h√†ng:', {
                status: status,
                error: error,
                responseText: xhr.responseText
            });
            
            $('#tbodyKhachHang').html(`
                <tr>
                    <td colspan="6" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        L·ªói t·∫£i d·ªØ li·ªáu: ${error}
                        <br><small class="text-muted">${xhr.responseText || 'Kh√¥ng c√≥ ph·∫£n h·ªìi'}</small>
                        <br><button class="btn btn-sm btn-primary mt-2" onclick="loadKhachHang()">Th·ª≠ l·∫°i</button>
                    </td>
                </tr>
            `);
        }
    });
}

function renderTable(list) {
    const tbody = $('#tbodyKhachHang');
    tbody.empty();
    
    if (list.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-people display-4 d-block mb-2"></i>
                    Ch∆∞a c√≥ kh√°ch h√†ng n√†o<br>
                    <button class="btn btn-primary-custom mt-2" data-bs-toggle="modal" data-bs-target="#modalKhachHang">
                        Th√™m kh√°ch h√†ng ƒë·∫ßu ti√™n
                    </button>
                </td>
            </tr>
        `);
        return;
    }
    
    list.forEach(kh => {
        console.log('üìù Rendering khachhang:', kh);
        tbody.append(`
            <tr>
                <td><strong>${escapeHtml(kh.TenKhachHang || '')}</strong></td>
                <td>${escapeHtml(kh.Email || '-')}</td>
                <td>${escapeHtml(kh.SoDienThoai || '-')}</td>
                <td>${escapeHtml(kh.DiaChi || '-')}</td>
                <td><small class="text-muted">${formatDate(kh.NgayDangKy)}</small></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning me-1" onclick="editKH(${kh.MaKhachHang})" title="S·ª≠a">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteKH(${kh.MaKhachHang})" title="X√≥a">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
    
    console.log('‚úÖ ƒê√£ render', list.length, 'kh√°ch h√†ng');
}

function saveKH() {
    const TenKhachHang = $('#TenKhachHang').val().trim();
    const SoDienThoai = $('#SoDienThoai').val().trim();
    
    if (!TenKhachHang || !SoDienThoai) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n kh√°ch h√†ng v√† S·ªë ƒëi·ªán tho·∫°i');
        return;
    }

    const data = {
        TenKhachHang: TenKhachHang,
        SoDienThoai: SoDienThoai,
        Email: $('#Email').val().trim(),
        DiaChi: $('#DiaChi').val().trim()
    };
    
    const id = $('#MaKhachHang').val();
    const method = id ? 'PUT' : 'POST';
    if (id) data.MaKhachHang = parseInt(id);

    $('#btnSaveKH').prop('disabled', true).html('<i class="bi bi-spinner spinner-border-sm"></i> ƒêang l∆∞u...');

    $.ajax({
        url: API_KH,
        type: method,
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(response) {
            $('#modalKhachHang').modal('hide');
            loadKhachHang();
            alert(response.message || (id ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m kh√°ch h√†ng th√†nh c√¥ng!'));
        },
        error: function(xhr) {
            let errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            try {
                const errorResponse = JSON.parse(xhr.responseText);
                errorMsg = errorResponse.message || errorResponse.error || xhr.responseText;
            } catch (e) {
                errorMsg = xhr.responseText || 'L·ªói k·∫øt n·ªëi';
            }
            alert('L·ªói: ' + errorMsg);
        },
        complete: function() {
            $('#btnSaveKH').prop('disabled', false).html('L∆∞u');
        }
    });
}

function editKH(id) {
    $.ajax({
        url: API_KH + '?MaKhachHang=' + id,
        type: 'GET',
        success: function(kh) {
            $('#MaKhachHang').val(kh.MaKhachHang);
            $('#TenKhachHang').val(kh.TenKhachHang);
            $('#Email').val(kh.Email);
            $('#SoDienThoai').val(kh.SoDienThoai);
            $('#DiaChi').val(kh.DiaChi);
            $('#modalTitle').text('S·ª≠a Kh√°ch h√†ng');
            $('#modalKhachHang').modal('show');
        },
        error: function(xhr) {
            alert('L·ªói t·∫£i th√¥ng tin kh√°ch h√†ng');
        }
    });
}

function deleteKH(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√°ch h√†ng n√†y?')) return;
    
    $.ajax({
        url: API_KH + '?MaKhachHang=' + id,
        type: 'DELETE',
        success: function(response) {
            if (response.success) {
                alert(response.message || 'X√≥a kh√°ch h√†ng th√†nh c√¥ng!');
                loadKhachHang();
            } else {
                alert(response.message || 'X√≥a th·∫•t b·∫°i!');
            }
        },
        error: function(xhr) {
            let errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            try {
                const errorResponse = JSON.parse(xhr.responseText);
                errorMsg = errorResponse.message || errorResponse.error || xhr.responseText;
            } catch (e) {
                errorMsg = xhr.responseText || 'L·ªói k·∫øt n·ªëi';
            }
            alert('L·ªói: ' + errorMsg);
        }
    });
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        return new Date(dateString).toLocaleDateString('vi-VN');
    } catch (e) {
        return '-';
    }
}

function dangXuat() {
    localStorage.clear();
    window.location.href = 'login.html';
}

// Test API connection
function testAPIConnection() {
    console.log('üß™ Testing API connection...');
    $.get(API_KH)
        .done(function(data) {
            console.log('‚úÖ API Connection SUCCESS');
        })
        .fail(function(xhr) {
            console.error('‚ùå API Connection FAILED:', xhr.status, xhr.statusText);
        });
}

// Event handlers
$('#btnSaveKH').click(saveKH);

$('#searchKhachHang').on('input', function() {
    const keyword = $(this).val();
    loadKhachHang(keyword);
});

$('#modalKhachHang').on('hidden.bs.modal', function() {
    $('#formKhachHang')[0].reset();
    $('#MaKhachHang').val('');
    $('#modalTitle').text('Th√™m Kh√°ch h√†ng');
});

$(document).ready(function() {
    console.log('üöÄ Trang khachhang.html ƒë√£ s·∫µn s√†ng');
    
    if (!kiemTraDangNhap()) return;
    
    // Test connection tr∆∞·ªõc
    testAPIConnection();
    
    // Load d·ªØ li·ªáu
    loadKhachHang();
    
    console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o xong trang qu·∫£n l√Ω kh√°ch h√†ng');
});
</script>
</body>
</html>